<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>helpers/cli.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-models_deployment-Deployment.html">Deployment</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-models_request-Request.html">Request</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-models_user-User.html">User</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-lib_classifier.html">lib/classifier</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-lib_deploy.html">lib/deploy</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-lib_helpers_cli.html">lib/helpers/cli</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_cli.html#~cacheCredentials">cacheCredentials</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_cli.html#~createBundle">createBundle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_cli.html#~getCredentials">getCredentials</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_cli.html#~getDeployments">getDeployments</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_cli.html#~login">login</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_cli.html#~logout">logout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_cli.html#~register">register</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_cli.html#~uploadBundle">uploadBundle</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-lib_helpers_util.html">lib/helpers/util</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_util.html#~contains">contains</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_util.html#~getPort">getPort</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_util.html#~hash">hash</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-models_deployment.html">models/deployment</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-models_deployment.html#~getDeployments">getDeployments</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-models_deployment.html#~getProxy">getProxy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-models_deployment.html#~updateDeployments">updateDeployments</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-models_request.html">models/request</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-models_request.html#~log">log</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-models_user.html">models/user</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-models_user.html#~authenticate">authenticate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-models_user.html#~get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-models_user.html#~login">login</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-models_user.html#~logout">logout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-models_user.html#~register">register</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">helpers/cli.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module lib/helpers/cli
 */

module.exports = function cli(url) {
  var methods = {};

  /**
   * creates a bundle to send to the server for deployment
   * @method createBundle
   * @param  {String}     directory - the directory that is to be turned into a tar
   * @return {Promise}
   */
  methods.createBundle = function createBundle(directory) {
    const tar = require('tar');
    const fs = require('fs');

    return tar.c({
      gzip: true,
      portable: true,
      file: 'bundle.tgz'
    }, fs.readdirSync(directory));
  };

  methods.removeBundle = function removeBundle(directory) {
    const fs = require('fs');
    const path = require('path');

    return new Promise(function(resolve, reject) {
      try {
        fs.unlink(path.resolve(directory, 'bundle.tgz'), () => {
          return resolve();
        });
      } catch(ex) {
        return reject(ex);
      }
    });
  };

  /**
   * Deals with uploading a specified bundle
   * @method uploadBundle
   * @param  {Object} options
   * @param  {String} options.name - the name of the specified application
   * @param  {Stream} options.bundle - a file stream of the tar
   * @return {Promise}
   */
  methods.uploadBundle = function uploadBundle({ name, bundle, token, username }) {
    const request = require('request');

    return new Promise(function(resolve, reject) {
      request.post({
        url: `${url}/upload`,
        headers: {
          'x-deploy-token': token,
          'x-deploy-username': username
        },
        formData: {
          name,
          bundle
        }
      }, function optionalCallback(err, httpResponse, body) {
        if (err) return reject(err);
        const response = JSON.parse(body);
        if(response.error) return reject(response.error);
        return resolve(response);
      });
    });
  };

  /**
   * calls the login api to get a token to persist for future requests
   * @method login
   * @param  {Object} options
   * @param  {String} options.username - username of the account
   * @param  {String} options.password - password associated with the account
   * @return {Promise}
   */
  methods.login = function login({ username, password }) {
    const request = require('request');

    return new Promise(function(resolve, reject) {
      request.post({
        url: `${url}/login`,
        form: {
          username,
          password
        }
      }, function optionalCallback(err, httpResponse, body) {
       if(err || httpResponse.statusCode !== 200) return reject('error trying to login');
       const response = JSON.parse(body);
       if(response.error) return reject(response.error);
       return resolve(response);
      });
    });
  };

  /**
   * prompts the user to register account
   * @method register
   * @param  {Object} options
   * @param  {String} options.username - username of the account
   * @param  {String} options.password - password associated with the account
   * @return {Promise}
   */
  methods.register = function register({ username, password }) {
    const request = require('request');

    return new Promise(function(resolve, reject) {
        request.post({
          url: `${url}/register`,
          form: {
            username,
            password
          }
        }, function optionalCallback(err, httpResponse, body) {
         if(err || httpResponse.statusCode !== 200) return reject('error trying to register email');
         const response = JSON.parse(body);
         if(response.error) return reject(response.error);
         return resolve(response);
        });
    });
  };

  /**
   * calls the logout api to invalidate token
   * @method logout
   * @param {Object} options
   * @param {String} options.token - token to make authenticated calls
   * @param {String} options.username - username linked to the token
   * @return {Promise}
   */
  methods.logout = function login({ token, username }) {
    const request = require('request');

    return new Promise(function(resolve, reject) {
      request.get({
        url: `${url}/api/logout`,
        headers: {
          'x-deploy-token': token,
          'x-deploy-username': username
        }
      }, function optionalCallback(err, httpResponse, body) {
        if (err) return reject('error trying to logout')
        const response = JSON.parse(body);
        if(response.error) return reject(response.error);
        return resolve(response);
      });
    });
  };

  /**
   * gets the user's deployed applications
   * @method getDeployments
   * @param {Object} options
   * @param {String} options.token - token to make authenticated calls
   * @param {String} options.username - username linked to the token
   * @param {String=} options.name - name of the deployment
   * @return {Promise}
   */
  methods.getDeployments = function getDeployments({ token, username, name }) {
    const request = require('request');

    let uri = `${url}/api/deployments`;
    if(name) uri += `/${name}`;

    return new Promise(function(resolve, reject) {
      request.get({
        url: uri,
        headers: {
          'x-deploy-token': token,
          'x-deploy-username': username
        }
      }, function optionalCallback(err, httpResponse, body) {
        if (err) return reject(err);
        const response = JSON.parse(body);
        if(response.error) return reject(response.error);
        return resolve(response);
      });
    });
  };

  methods.getUserDetails = function getUserDetails({ token, username }) {
    const request = require('request');

    return new Promise(function(resolve, reject) {
      request.get({
        url: `${url}/api/user`,
        headers: {
          'x-deploy-token': token,
          'x-deploy-username': username
        }
      }, function optionalCallback(err, httpResponse, body) {
        if (err) return reject(err);
        const response = JSON.parse(body);
        if(response.error) return reject(response.error);
        return resolve(response);
      });
    });
  };

  /**
   * persists the token and username locally
   * @method cacheCredentials
   * @param {Object} options
   * @param {String} options.token - token to make authenticated calls
   * @param {String} options.username - username linked to the token
   * @return {Promise}
   */
  methods.cacheCredentials = function cacheCredentials({ username, token }) {
    const os = require('os');
    const fs = require('fs');
    const path = require('path');

    return new Promise((resolve, reject) => {
      const credentials = {
        username,
        token
      };
      const configPath = path.resolve(os.homedir(), 'deploy.json');
      try {
        fs.writeFileSync(configPath, JSON.stringify(credentials, null, 4));
      } catch(ex) {
        reject(ex);
      }
      return resolve({
        username,
        token
      });
    });
  };

  /**
   * gets the token and username that were persisted locally
   * @method getCredentials
   * @return {Promise}
   */
  methods.getCredentials = function getCredentials() {
    const os = require('os');
    const fs = require('fs');
    const path = require('path');

    return new Promise((resolve, reject) => {
      const configPath = path.resolve(os.homedir(), 'deploy.json');
      try {
        const credentials = JSON.parse(fs.readFileSync(configPath));
        const { username, token } = credentials;
        if(username &amp;&amp; token) {
          return resolve({
            username,
            token
          });
        } else {
          reject('credentials not found');
        }
      } catch(ex) {
        reject(ex);
      }
    });
  };

  return methods;
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.4</a> on Fri Aug 11 2017 00:05:36 GMT-0700 (PDT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
