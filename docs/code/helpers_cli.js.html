<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>helpers/cli.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="CLI.html">CLI</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CLI.html#.cacheCredentials">cacheCredentials</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CLI.html#.createBundle">createBundle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CLI.html#.deleteDeployment">deleteDeployment</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CLI.html#.getCredentials">getCredentials</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CLI.html#.getDeployments">getDeployments</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CLI.html#.getLogs">getLogs</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CLI.html#.getUserDetails">getUserDetails</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CLI.html#.login">login</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CLI.html#.logout">logout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CLI.html#.register">register</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CLI.html#.removeBundle">removeBundle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CLI.html#.uploadBundle">uploadBundle</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Deployment.html">Deployment</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Deployment.html#.decorate">decorate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Deployment.html#.del">del</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Deployment.html#.get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Deployment.html#.getAll">getAll</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Deployment.html#.logs">logs</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Deployment.html#.proxy">proxy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Deployment.html#.remove">remove</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Deployment.html#.start">start</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Deployment.html#.stop">stop</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Deployment.html#.update">update</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Request.html">Request</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Request.html#.count">count</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Request.html#.del">del</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Request.html#.log">log</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="User.html">User</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="User.html#.authenticate">authenticate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="User.html#.authenticateMiddleware">authenticateMiddleware</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="User.html#.login">login</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="User.html#.logout">logout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="User.html#.register">register</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-lib_classifier.html">lib/classifier</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-lib_deploy.html">lib/deploy</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-lib_helpers_util.html">lib/helpers/util</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_util.html#.mk">mk</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_util.html#~contains">contains</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_util.html#~getPort">getPort</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-lib_helpers_util.html#~hash">hash</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">helpers/cli.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const tar = require('tar');
const os = require('os');
const fs = require('fs');
const path = require('path');
const { promisify } = require('util');

const { request } = require('./util');

const unlink = promisify(fs.unlink);
const writeFile = promisify(fs.writeFile);
const readFile = promisify(fs.readFile);

class CLI {
  /**
   * the cli instance that holds all options and methods to talk to the deploy.sh service
   * @class CLI
   * @param {Object} options - contains defaults and overrides
   * @param {String} options.url - the url of the remote deploy.sh service
   * @param {String} options.application - the deployed application name to alter
   * @param {String} options.mongo - the mongo connection string used by deploy.sh service when running `deploy serve --mongo ''`
   */
  constructor(options) {
    this.url = options.url;
    this.application = options.application;
    this.mongo = options.mongo;
  }
  /**
   * creates a bundle to send to the server for deployment
   * @memberof CLI
   * @method createBundle
   * @param  {String}     directory - the directory that is to be turned into a tar
   * @return {Promise}
   */
  createBundle(directory) {
    return tar.c({
      gzip: true,
      portable: true,
      file: 'bundle.tgz'
    }, fs.readdirSync(directory));
  }
  /**
   * removes the bundle from the given directory
   * @memberof CLI
   * @method removeBundle
   * @param  {String} directory - path to directory
   * @return {Promise}
   */
  async removeBundle(directory) {
    return await unlink(path.resolve(directory, 'bundle.tgz'));
  }
  /**
   * Deals with uploading a specified bundle
   * @memberof CLI
   * @method uploadBundle
   * @param  {Object} options
   * @param  {String} options.name - the name of the specified application
   * @param  {Stream} options.bundle - a file stream of the tar
   * @return {Promise}
   */
  async uploadBundle({ name, bundle, token, username }) {
    return await request('post', {
      url: `${this.url}/upload`,
      headers: {
        'x-deploy-token': token,
        'x-deploy-username': username
      },
      formData: {
        name,
        bundle
      }
    });
  }
  /**
   * calls the login api to get a token to persist for future requests
   * @method login
   * @memberof CLI
   * @param  {Object} options
   * @param  {String} options.username - username of the account
   * @param  {String} options.password - password associated with the account
   * @return {Promise}
   */
  async login({ username, password }) {
    return await request('post', {
      url: `${this.url}/login`,
      form: {
        username,
        password
      }
    });
  }
  /**
   * prompts the user to register account
   * @method register
   * @memberof CLI
   * @param  {Object} options
   * @param  {String} options.username - username of the account
   * @param  {String} options.password - password associated with the account
   * @return {Promise}
   */
  async register({ username, password }) {
    return await request('post', {
      url: `${this.url}/register`,
      form: {
        username,
        password
      }
    });
  }
  /**
   * calls the logout api to invalidate token
   * @memberof CLI
   * @method logout
   * @param {Object} options
   * @param {String} options.token - token to make authenticated calls
   * @param {String} options.username - username linked to the token
   * @return {Promise}
   */
  async logout({ token, username }) {
    return await request('get', {
      url: `${this.url}/api/logout`,
      headers: {
        'x-deploy-token': token,
        'x-deploy-username': username
      }
    });
  }
  /**
   * gets the application logs
   * @memberof CLI
   * @method getLogs
   * @param {Object} options
   * @param {String} options.token - token to make authenticated calls
   * @param {String} options.username - username linked to the token
   * @param {String} options.name - name of the deployment
   * @return {Promise}
   */
  async getLogs({ token, username, name }) {
    return await request('get', {
      url: `${this.url}/api/deployments/${name}/logs`,
      headers: {
        'x-deploy-token': token,
        'x-deploy-username': username
      }
    });
  }
  /**
   * gets the user's deployed applications
   * @memberof CLI
   * @method getDeployments
   * @param {Object} options
   * @param {String} options.token - token to make authenticated calls
   * @param {String} options.username - username linked to the token
   * @param {String=} options.name - name of the deployment
   * @return {Promise}
   */
  async getDeployments({ token, username, name }) {
    let uri = `${this.url}/api/deployments`;
    if(name) uri += `/${name}`;

    return await request('get', {
      url: uri,
      headers: {
        'x-deploy-token': token,
        'x-deploy-username': username
      }
    });
  }
  /**
   * deletes the specified deployment
   * @memberof CLI
   * @method deleteDeployment
   * @param {Object} options
   * @param {String} options.token - token to make authenticated calls
   * @param {String} options.username - username linked to the token
   * @param {String} options.name - name of the deployment
   * @return {Promise}
   */
  async deleteDeployment({ name, token, username }) {
    return await request('delete', {
      url: `${this.url}/api/deployments/${name}`,
      headers: {
        'x-deploy-token': token,
        'x-deploy-username': username
      }
    });
  }
  /**
   * gets the user details
   * @memberof CLI
   * @method getUserDetails
   * @param {String} options.token - token to make authenticated calls
   * @param {String} options.username - username linked to the token
   * @return {Promise}
   */
  async getUserDetails({ token, username }) {
    return await request('get', {
      url: `${this.url}/api/user`,
      headers: {
        'x-deploy-token': token,
        'x-deploy-username': username
      }
    });
  }
  /**
   * persists the token and username locally
   * @memberof CLI
   * @method cacheCredentials
   * @param {Object} options
   * @param {String} options.token - token to make authenticated calls
   * @param {String} options.username - username linked to the token
   * @return {Promise}
   */
  async cacheCredentials({ username, token }) {
    const credentials = {
      username,
      token
    };
    const configPath = path.resolve(os.homedir(), '.deployrc');

    await writeFile(configPath, JSON.stringify(credentials, null, 4));

    return {
      username,
      token
    };
  }
  /**
   * gets the token and username that were persisted locally
   * @memberof CLI
   * @method getCredentials
   * @return {Promise}
   */
  async getCredentials() {
    try {
      const configPath = path.resolve(os.homedir(), '.deployrc');
      const credentials = JSON.parse(await readFile(configPath));
      const { username, token } = credentials;
      if(username &amp;&amp; token) {
        return {
          username,
          token
        };
      } else {
        throw new Error('credentials not found');
      }
    } catch(ex) {
      if(ex.code === 'ENOENT') {
        throw new Error('You are not logged in, please login to view identity');
      }
      throw new Error(ex);
    }
  }
}

module.exports = CLI;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
